G.Layer.Tile=G.Layer.Tile.extend({_initContainer:function(){var b=this._map,a=G.DomUtil,c=this._container=a.create("div","g-layer");this._bg=a.create("div","g-tile-container g-zoom-animated",this._container);this._front=a.create("div","g-tile-container g-zoom-animated",this._container);b._layersFrame.appendChild(this._container);a.setZIndex(c,this._zIndex)},_destroyContainer:function(){this._container.parentNode.removeChild(this._container);delete this._container},_update:function(){var b=this._map;
if(b._isLoaded()){var a=this._zoom=this._calcNearestZoom(!0),c=this._calcVisTileInfos(!0);b.getSize();var d=b.getCenter(),e=this.options,f=e.zoomReses[a],h=e.tileSize,k=b.getDrawSize(),m=k[0],k=k[1],f=[d[0]-m*f/2,d[1]-k*f/2,d[0]+m*f/2,d[1]+k*f/2],b=b.options.maxExtent,q,p,l;this._redrawExtent=f;var f=G.ExtentUtil.intersect(f,b),n;for(n in this._tiles)p=this._tiles[n],b=p._info,q=b[0],m=b[1],l=b[2],k=e.zoomReses[l],l!==a&&(this._stopLoadingTile(p),(!e.keepResample||1>e.opacity)&&this._removeTile(n)),
p=e.originX+q*h*k,q=e.originX+(q+1)*h*k,l=e.originY-(m+1)*h*k,m=e.originY-m*h*k,(m=G.ExtentUtil.overlaps([p,l,q,m],f))||this._tileInfoExist(b,c)||this._removeTile(n);this._placeLoadedTiles(this._bg);this._placeLoadedTiles(this._front);a=this._calcTileIndex(d[0],d[1],a);this._sortTileInfos(c,a[0],a[1]);this._addTiles(c)}},_draw:function(){var b=G.DomUtil;this._map._isLoaded()&&(b.show(this._bg),b.show(this._front),b.setZIndex(this._container,this._zIndex),this._placeLoadedTiles(this._bg),this._placeLoadedTiles(this._front))},
_erase:function(){var b=G.DomUtil;b.hide(this._bg);b.hide(this._front)},_onZoomStart:function(b){var a=this._map,c=a._mapFrame,d=a.getSize(),e=a._rotate,f=this._front,h=this._bg,k=G.DomUtil,m=k.Transition,k=k.Transform;if(!this._zooming){this._zooming=!0;this._prepareBgBuffer();var d=[d[0]/2,d[1]/2],q=b.aroundScreen||d,p=d[0]-q[0],l=d[1]-q[1];e&&(p&&l)&&(e=G.MathUtil.rotateVector([p,l],-e),q=[d[0]-e[0],d[1]-e[1]]);this._aroundScreen=q;a=a._zoomAnim&&a._zoomAnim._params.ignoreAnim;b=G.DomUtil.genScaleStyle(1/
b.scale,q[0],q[1]);f.style[k]=b;h.style[k]=b;a||(f.style[m]=c.style[m],h.style[m]=c.style[m])}},_onZoomUpdate:function(b){var a=this._front,c=this._bg,d=G.DomUtil,e=d.Transform;if(this._zooming){var f=this._aroundScreen;b=d.genScaleStyle(1/b.scale,f[0],f[1]);a.style[e]=b;c.style[e]=b}},_onZoomEnd:function(){var b=this._front,a=this._bg,c=G.DomUtil,d=c.Transition,c=c.Transform;b.parentNode.appendChild(b);b.style[c]="";b.style[d]="";a.style[c]="";a.style[d]="";this._zooming=!1},_clearBgBuffer:function(){var b=
this._map;b&&!b._zooming&&(this._bg.innerHTML="")},_prepareBgBuffer:function(){var b=this._front,a=this._bg;this._stopLoadingTiles(a);this._front=a;this._bg=b},_placeLoadedTiles:function(b){var a=this.options.zoomReses.length,c=this._calcNearestZoom(!0);b=b.getElementsByTagName("img");for(var d,e,f,h,k,m=0,q=b.length;m<q;m++)(d=b[m])&&d.complete&&(e=d._info,f=parseInt(e[0]),h=parseInt(e[1]),e=parseInt(e[2]),k=e==c?a+1:e,this._placeTile(d,f,h,e,k))},_addTiles:function(b){if(0!==b.length){this._numLoad=
b.length;this._numLoadError=this._numLoadSuccess=0;for(var a=document.createDocumentFragment(),c=this.options,d=c.zoomReses.length,e,f,h,k,m,q=this.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE,p=0,l=b.length;p<l;p++){e=b[p];f=e[0];h=e[1];k=e[2];m=this._getTileName(f,h,k);(e=this._tiles[m])?e.src==q?+new Date-e._responseTime>c.tileLiveMs&&this._loadTile(e,f,h,k):this._numLoadSuccess++:(e=this._getIdleTile(),this._tiles[m]=e,this._loadTile(e,f,h,k));if(e.parentNode!==this._front&&(a.appendChild(e),
e._wraps))for(var n in e._wraps)(m=e._wraps[n])&&m.parentNode!==this._front&&a.appendChild(m);this._placeTile(e,f,h,k,d)}this._front.appendChild(a);this._checkAllHandled()}},_onNewWrapTile:function(b,a){var c=b._wraps[a];c&&c.parentNode!==this._front&&this._front.appendChild(c)}});
G.Layer.Graphic=G.Layer.Graphic.extend({_initContainer:function(){var b=this._map,a=G.DomUtil,c=this._container=a.create("div","g-layer");this._svg=a.createSVG("svg","g-graphic-container g-zoom-animated",c);this._defs=a.createSVG("defs","",this._svg);b._layersFrame.appendChild(c);a.setZIndex(c,this._zIndex)},_update:function(){this.isVisible()?this._draw():this._erase()},_draw:function(){var b=this._map,a=G.DomUtil,c=this._svg,d=a.getPosition(b._mapFrame),e=b.getSize(),f=b.getDrawSize(),h=f[0],f=
f[1],k=(h-e[0])/2,e=(f-e[1])/2;if(!(b.isZooming()||b.isDragging()||b.isPanning()||b.isRotating())){a.setZIndex(this._container,this._zIndex);a.show(c);c.style[a.Transform]=a.genTranslateStyle(-k,-e);c.setAttribute("width",h);c.setAttribute("height",f);c.setAttribute("viewBox",[-d[0],-d[1],h,f].join(" "));var b=b.getRedrawExtent(),m;for(m in this._graphics)a=this._graphics[m],c=a.bbox,a._layer&&G.ExtentUtil.overlaps(c,b)?a._draw():a._erase()}},_erase:function(){G.DomUtil.hide(this._svg)},_onClear:function(){var b=
this._svg;if(b){for(b.innerHTML="";b.lastChild;)b.removeChild(b.lastChild);this._defs=G.DomUtil.createSVG("defs","",this._svg)}},_onZoomStart:function(b){var a=this._map,c=a._mapFrame,d=a._rotate,e=this._svg,f=G.DomUtil,h=f.Transition,f=f.Transform;if(e){this._zooming||(this._zooming=!0);var k=a.getSize(),m=a.getDrawSize(),q=(m[0]-k[0])/2,m=(m[1]-k[1])/2,k=[k[0]/2,k[1]/2],p=b.aroundScreen||k,l=k[0]-p[0],n=k[1]-p[1];d&&(l&&n)&&(d=G.MathUtil.rotateVector([l,n],-d),p=[k[0]-d[0],k[1]-d[1]]);p=this._aroundScreen=
[p[0]-k[0],p[1]-k[1]];b=G.DomUtil.genScaleStyle(1/b.scale,p[0],p[1],-q,-m);e.style[f]=b;a._zoomAnim&&a._zoomAnim._params.ignoreAnim||(e.style[h]=c.style[h])}},_onZoomUpdate:function(b){var a=this._map,c=a._mapFrame,d=this._svg,e=G.DomUtil,f=e.Transition,e=e.Transform;if(d&&this._zooming){var h=this._aroundScreen,k=a.getSize(),m=a.getDrawSize();b=G.DomUtil.genScaleStyle(1/b.scale,h[0],h[1],-((m[0]-k[0])/2),-((m[1]-k[1])/2));d.style[e]=b;a._zoomAnim&&a._zoomAnim._params.ignoreAnim||(d.style[f]=c.style[f])}},
_onZoomEnd:function(){var b=this._map,a=this._svg,c=G.DomUtil;if(a){var d=b.getSize(),e=b.getDrawSize(),b=(e[0]-d[0])/2,d=(e[1]-d[1])/2;a.style.visibility="";a.parentNode.appendChild(a);a.style[c.Transform]=c.genTranslateStyle(-b,-d);a.style[c.Transition]="";this._zooming=!1}}});
G.Layer.Label=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{icons:"",cluster:[],crossOrigin:"*"},init:function(b,a){G.Layer.Graphic.prototype.init.call(this,a);this.url=b;this.options=G.Util.merge({},this.options,a);this._lts={};this._gx=this._gy=10},_initContainer:function(){G.Layer.Graphic.prototype._initContainer.call(this)},_onAdded:function(){this._container||this._initContainer()},_onRemoved:function(){this._container&&this._destroyContainer()},_update:function(){var b=this._map;G.Layer.Graphic.prototype._update.call(this);
if(b._isLoaded()){var a=this._zoom=this._calcNearestZoom(!0),c=b.getCenter();this._clearGrids();b=b._zoomAnim;b&&b._playing||(b=this._calcVisTileInfos(),a=this._calcTileIndex(c[0],c[1],a),this._sortTileInfos(b,a[0],a[1]),this._setLts(b))}},_setLts:function(b){if(b.length){for(var a=[],c,d,e,f,h,k=0,m=b.length;k<m;k++)c=b[k],e=c[0],f=c[1],h=c[2],c=this._getTileName(e,f,h),a.push(c),c in this._lts?(d=this._lts[c],d.loading||d.data||d.ri||this._loadLtI(e,f,h)):this._loadLtI(e,f,h),this._placeLt(c);this._dirtyTileKeys=
this._dirtyTileKeys||[];for(c in this._lts)-1<a.indexOf(c)||(this._stopLoadingLt(c),this._dirtyTileKeys.push(c))}},_checkDirtyTiles:function(){var b=this._dirtyTileKeys,a;if(b&&0<b.length)for(var c=0,d=b.length;c<d;c++)a=b[c],this._removeLt(a);this._dirtyTileKeys=[]},_placeLt:function(b){if((b=this._lts[b])&&b._info&&b.data){var a=b.data.l,c,d,e,f,h,k,m,q,p,l,n,r;for(c in a)for(n in d=a[c],e=Number(d[0]),f=Number(d[1]),d=d[6],e=[e,f],f="imgs"+c,l=b[f],l)f=l[n],h=f[0],k=f[1],m=f[2],q=f[3],p=f[4],r=
f[5],r||(f[5]=r=new G.Graphic.Point(e,null,{shape:"image",size:[k,m],offset:[q,p],image:h,imageGravity:!!d}),r.addTo(this))}},_removeLt:function(b){var a=this._lts[b];if(a&&a._info&&a.data){this._stopLoadingLt(b);var c=a.data.l,d,e,f;for(d in c)for(f in c="imgs"+d,e=a[c],e)c=e[f],(g=c[5])&&g.remove();delete this._lts[b]}},_loadLtI:function(b,a,c){var d=this,e=d._getTileName(b,a,c),f=d._lts[e]=d._lts[e]||{};f._info=[b,a,c];""!==f.data&&(f.loading=!0,b=d._getTileUrl(b,a,c,{d:"i",i:G.Browser.retina?
"@2x":""}),a={},d.options.crossOrigin&&(a.crossOrigin=d.options.crossOrigin),a={responseType:"http"===b.slice(0,4).toLowerCase()?"JSONP":"JSON",header:a,success:function(a,b){f.data=b;d._processLt(e)},error:function(a){404==a.status&&(f.data="")},complete:function(){delete f.ri;f.loading=!1}},d.options.crossOrigin&&(a.responseType="JSON"),b=G.Util.ajax(b,a),f.ri=b)},_processLt:function(b){var a=this._lts[b],c=a.data;if(c){var d=c.l,e=c.b,f=c.i,c=c.bb,h=this.options.icons||"",k,m,q,p,l,n,r,u,s;for(k in d){if(e&&
k in e)for(r=e[k],u=0,s=r.length;u<s;u++)n=r[u],d=n[0],m=n[1],q=n[2],p=n[3],l=n[4],n=n[5],0!=n&&c&&(l=c.slice(l,l+n),l="data:image/png;base64,"+l,n="b"+u,a["imgs"+k]=a["imgs"+k]||{},a["imgs"+k][n]=[l,d,m,q,p]);if(f&&k in f)for(r=f[k],u=0,s=r.length;u<s;u++)l=r[u],d=l[0],m=l[1],q=l[2],p=l[3],l=l[4],l=h+l,n="i"+u,a["imgs"+k]=a["imgs"+k]||{},a["imgs"+k][n]=[l,d,m,q,p]}this._checkDirtyTiles();this._placeLt(b)}},_stopLoadingLt:function(b){b=this._lts[b];var a=G.Util.ajaxCancel;b&&(a(b.ri),b.loading=!1)},
_onIconLoad:function(){this._dirtyIcons=!0},_clearGrids:function(){this._g={}},_hitGrids:function(b,a,c,d){for(var e=b;e<=c;e++)for(var f=a;f<=d;f++)if(b=e+","+f,this._g[b])return!0;return!1},_markGrids:function(b,a,c,d){for(var e=b;e<=c;e++)for(var f=a;f<=d;f++)b=e+","+f,this._g[b]=!0}});
G.Layer.VectorCache=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{cluster:[]},init:function(b,a){G.Layer.Graphic.prototype.init.call(this,a);this.url=b;this.options=G.Util.merge({},this.options,a);this._vts={};this._visVtKeys=[];this._vIds={}},_initContainer:function(){G.Layer.Graphic.prototype._initContainer.call(this)},_onAdded:function(){this._container||this._initContainer()},_onRemoved:function(){this._container&&this._destroyContainer()},_update:function(){var b=this._map;G.Layer.Graphic.prototype._update.call(this);
b._isLoaded()&&(b=this._calcVisTileInfos(),this._addVts(b))},_addVts:function(b){if(0!==b.length){var a,c,d=[],e,f,h,k;a=0;for(c=b.length;a<c;a++)e=b[a],f=e[0],h=e[1],k=e[2],e=this._getTileName(f,h,k),d.push(e),e in this._vts?(f=this._vts[e],f.data&&this._processVt(e)):this._loadVt(f,h,k);a=0;for(c=this._visVtKeys.length;a<c;a++)e=this._visVtKeys[a],0>d.indexOf(e)&&this._removeVt(e);this._visVtKeys=d}},_removeVt:function(b){this._vts[b]&&this._stopLoadingVt(b)},_loadVt:function(b,a,c){var d=this,
e=d._getTileName(b,a,c),f=d._vts[e]=d._vts[e]||{};f._info=[b,a,c];""!==f.data&&(f.loading=!0,b=d._getTileUrl(b,a,c,{d:"f"}),a={responseType:"http"===b.slice(0,4).toLowerCase()?"JSONP":"JSON",success:function(a,b){f.data=b;d._processVt(e)},error:function(a){404==a.status&&(f.data="")},complete:function(){delete f.req;f.loading=!1}},b=G.Util.ajax(b,a),f.req=b)},_processVt:function(b){for(var a=this._map,c=this._vts[b].data,d=c.v,c=c.s,e,f,h,k,m,q=G.Util.colorHex,p=0,l=d.length;p<l;p++)e=d[p],f=e.id,
h=e.g,k=e.gt,e=e.st,e=c[e],(m=this._vIds[f])?m._updateGeom(h):"pt"===k?m=new G.Graphic.Point(h):"pl"===k?m=new G.Graphic.Polyline(h):"pg"===k&&(m=new G.Graphic.Polygon(h)),m&&(h=m.options,"pt"!==k&&"pl"===k&&(k=e.line_color,h.lineWidth=e.line_width,h.lineColor=q(k[0],k[1],k[2])),m&&(m.addTo(this),m._vtKeys=m._vtKeys||{},m._vtKeys[b]=!0,this._vIds[f]=m));a._requestRedraw()},_stopLoadingVt:function(b){b=this._vts[b];var a=G.Util.ajaxCancel;b&&(a(b.req),b.loading=!1)}});
G.Layer.FeatureService=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{mode:"all",vacuumCount:1E3},init:function(b,a){G.Layer.Graphic.prototype.init.call(this,a);this.options=G.Util.merge({},this.options,a);this._reqFunc=b;this._loadingKeys={}},onSuccess:function(b){"tile"==this.options.mode?this.fireEvent("loadTileSuccess",{extent:b}):this.fireEvent("loadAllSuccess")},onError:function(b){"tile"==this.options.mode?this.fireEvent("loadTileError",{extent:b}):this.fireEvent("loadAllError")},onComplete:function(b){if("tile"==
this.options.mode){var a=b.join(",");delete this._loadingKeys[a];this.fireEvent("loadTileComplete",{extent:b})}else this.fireEvent("loadAllComplete")},_update:function(){var b=this._map;G.Layer.Graphic.prototype._update.call(this);b._isLoaded()&&("tile"==this.options.mode?(this.count()>this.options.vacuumCount&&this._vacuum(),b=this._calcVisTileInfos(),this._addFts(b)):this._loadAll())},_addFts:function(b){if(0!==b.length){var a,c,d,e,f,h=this._loadingKeys,k={};a=0;for(c=b.length;a<c;a++)e=b[a],d=
e[0],f=e[1],e=e[2],f=this._calcTileExtent(d,f,e),d=f.join(","),k[d]=f;for(d in h)k[d]||(b=h[d],G.Util.ajaxCancel(b),delete h[d]);for(d in k)f=k[d],this._loadFt(f)}},_loadFt:function(b){var a=b.join(","),c=this._reqFunc;a in this._loadingKeys||!c||(c=c.call(this,b),this._loadingKeys[a]=c,this.fireEvent("loadTileStart",{extent:b}))},_loadAll:function(){var b=this._reqFunc;"all"in this._loadingKeys||!b||(b=b.call(this),this._loadingKeys.all=b,this.fireEvent("loadAllStart"))}});
G.Layer.GeoHeyFeature=G.Layer.FeatureService.extend({options:{apiKey:"",where:"1=1",outFields:"",limit:1E3},init:function(b,a){var c=this;G.Layer.FeatureService.prototype.init.call(c,function(a){var e=b+"/query",f=c.options,h={ak:f.apiKey,where:f.where,outFields:f.outFields,limit:f.limit};a&&(h.geometry=JSON.stringify(a));h={responseType:"http"===e.slice(0,4).toLowerCase()?"JSONP":"JSON",data:h,success:function(b,e){var h=e.data,p=h.geometryType;if(h=h.features){var l;l=h.length-1;for(var n=Math.max(0,
l-f.limit),r,u,s,t=[],w;l>=n;l--)for(w in r=h[l],u=r.id,s=r.geom,r=r.attrs||{},"Point"==p?t.push(new G.Graphic.Point(s,r)):"Polyline"==p?t.push(new G.Graphic.Polyline(s,r)):"Polygon"==p?t.push(new G.Graphic.Polygon(s,r)):"MultiPoint"==p?t.push(new G.Graphic.MultiPoint(s,r)):"MultiPolyline"==p?t.push(new G.Graphic.MultiPolyline(s,r)):"MultiPolygon"==p&&t.push(new G.Graphic.MultiPolygon(s,r)),t)if(r=t[w])s=u+"_"+w,c.get(s)||r.addTo(c,s)}c.onSuccess(a)},error:function(){c.onError(a)},complete:function(){c.onComplete(a)}};
G.Util.ajax(e,h)},a)}});
G.Layer.GeoHeyProgressiveFeature=G.Layer.Graphic.extend({options:{stepFactor:4,stepCount:4,tolerance:8,outFields:"[]"},init:function(b,a){G.Layer.Graphic.prototype.init.call(this,a);this.url=b},onSuccess:function(b){this.fireEvent("extentSuccess",{extent:b})},onError:function(b){this.fireEvent("extentError",{extent:b})},onComplete:function(b){this.fireEvent("extentComplete",{extent:b})},_update:function(){var b=this._map,a=this._loadRes=b._res,c=this._loadExtent=b.getExtent(),d=this._loadedStatus;
if(!d||a!=d[0]||!G.ExtentUtil.equals(c,d[1]))if(G.Layer.Graphic.prototype._update.call(this),b._isLoaded()){(b=this._req)&&G.Util.ajaxCancel(b);var e,a=this._graphics;for(e in a)b=a[e],b._dirty=!0;this._loadStep(1)}},_loadStep:function(b){var a=this,c=a.options,d=a._loadRes,e=a._loadExtent,f=c.tolerance*Math.pow(c.stepFactor,c.stepCount-b),h=a.url+"/filter",c={responseType:"JSON",data:{extent:JSON.stringify(e),excludeExtents:JSON.stringify([]),res:d,cellPixel:f,outFields:c.outFields},success:function(c,
d){a._processResult(b,d)},complete:function(){a._req=null}};a._req=G.Util.ajax(h,c)},_processResult:function(b,a){var c=this.options,d=this._loadRes,e=this._loadExtent,f=c.tolerance*Math.pow(c.stepFactor,c.stepCount-b),f=d*f,h=a.geometryType,k=a.features;if(k){var m,q,p,l,n,r;for(m=k.length-1;0<=m;m--)if(q=k[m],p=q.id,l=q.geom,q=q.attrs||{},"Point"==h)r=new G.Graphic.Point(l,q),this._updateGraphic(f,p,0,r);else if("Polyline"==h)r=new G.Graphic.Polyline(l,q),this._updateGraphic(f,p,0,r);else if("Polygon"==
h)r=new G.Graphic.Polygon(l,q),this._updateGraphic(f,p,0,r);else if("MultiPoint"==h)for(n in l.multi)r=l.multi[n],r=new G.Graphic.Point(r,q),this._updateGraphic(f,p,n,r);else if("MultiPolyline"==h)for(n in l.multi)r=l.multi[n],r=new G.Graphic.Polyline(r,q),this._updateGraphic(f,p,n,r);else if("MultiPolygon"==h)for(n in l.multi)r=l.multi[n],r=new G.Graphic.Polygon(r,q),this._updateGraphic(f,p,n,r);b<c.stepCount?this._loadStep(b+1):(this._clearDirty(),this._loadedStatus=[d,e],this.onSuccess(e),this.onComplete(e))}else this.onError(e),
this.onComplete(e)},_updateGraphic:function(b,a,c,d){a+=c?"_"+c:"";(c=this.get(a))?(b<c._res&&(c.updateGeom(d.geom,!0),c._res=b),c._dirty=!1):(d._res=b,d.addTo(this,a))},_clearDirty:function(){var b=this._graphics,a,c;for(c in b)a=b[c],a._dirty&&a.remove()}});
G.Layer.TiledService=G.Layer.extend({mixins:[G.Layer.LOD],init:function(b,a){this.options=G.Util.merge({},this.options,a);this._reqFunc=b;this._loadingKeys={};this._loadedKeys={}},onSuccess:function(b,a){this._numLoadSuccess++;var c=parseInt(b[0]),d=parseInt(b[1]),e=parseInt(b[2]),c=this._getTileName(c,d,e);this._loadedKeys[c]=b;this.fireEvent("loadTileSuccess",{tileInfo:b,data:a})},onError:function(b){this._numLoadError++;this.fireEvent("loadTileError",{tileInfo:b})},onComplete:function(b){var a=
parseInt(b[0]),c=parseInt(b[1]),d=parseInt(b[2]),a=this._getTileName(a,c,d);delete this._loadingKeys[a];this.fireEvent("loadTileComplete",{tileInfo:b});this._checkAllHandled()},_update:function(){if(this._map._isLoaded()){var b,a,c,d,e,f,h=this._calcVisTileInfos(),k={};b=0;for(a=h.length;b<a;b++)d=h[b],c=d[0],e=d[1],f=d[2],c=this._getTileName(c,e,f),k[c]=d;this._addTiles(k);for(c in this._loadedKeys)k[c]||(d=this._loadedKeys[c],delete this._loadedKeys[c],this.fireEvent("unusedTile",{tileInfo:d}));
this._onUpdated()}},_addTiles:function(b){var a,c,d=this._loadingKeys;for(a in d)b[a]||(c=d[a],G.Util.ajaxCancel(c),delete d[a]);this._numLoad=Object.keys(b).length;this._numLoadError=this._numLoadSuccess=0;for(a in b)c=b[a],this._loadTile(c);this._checkAllHandled()},_loadTile:function(b){var a=this._reqFunc,c=parseInt(b[0]),d=parseInt(b[1]),e=parseInt(b[2]),f=this._getTileName(c,d,e);f in this._loadingKeys||!a||(f in this._loadedKeys?this._numLoadSuccess++:(a=a.call(this,c,d,e),this._loadingKeys[f]=
a,this.fireEvent("loadTileStart",{tileInfo:b})))},_stopLoadingByKey:function(b){var a=this._loadingKeys,c=a[b];c&&(G.Util.ajaxCancel(c),delete a[b])},_checkAllHandled:function(){this._numLoad==this._numLoadSuccess+this._numLoadError&&this.fireEvent("allLoaded")},_onUpdated:function(){}});
G.Graphic.Point=G.Graphic.Point.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._points={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this.options,c=this._layer,d=c._map;if(this.geom){c=c._svg;this._dom&&(c&&!this._dom.parentNode)&&c.appendChild(this._dom);var e=d.getSize(),f=d.getDrawSize(),c=(f[0]-e[0])/
2,e=(f[1]-e[1])/2,f=d._rotate,h=a.shape,k=a.size,m=k[0],k=k[1],q=a.offset,p=a.imageRotate;"image"==h&&p&&(f-=p);"image"!=h||a.imageGravity||(f-=d._rotate);for(var p=this.geom[0],l=this.geom[1],n=d._calcWrapPointRange(this.geom)||[0,0],r=d.options.maxExtent,r=r[2]-r[0],u=n[0];u<=n[1];u++){var s=this._points[u];s||(s="rect"==h?this._points[u]=b.createSVG("rect"):"image"==h?this._points[u]=b.createSVG("image"):"text"==h?this._points[u]=b.createSVG("text"):this._points[u]=b.createSVG("circle"),s._graphic=
this,this._dom.appendChild(s));var t=d.toScreen([p+u*r,l],0,0,!0),w=t[0]+c,v=t[1]+e,t=w+q[0],y=v+q[1],w="rotate("+-f+","+w+","+v+")";if("circle"==h)s.setAttribute("cx",t),s.setAttribute("cy",y),s.setAttribute("r",m/2);else if("rect"==h)s.setAttribute("x",t-m/2),s.setAttribute("y",y-k/2),s.setAttribute("width",m),s.setAttribute("height",k);else if("image"==h)s.setAttribute("x",t),s.setAttribute("y",y),s.setAttribute("width",m),s.setAttribute("height",k),t=G.Browser.getImageSrc(a.image),s.setAttributeNS(G.DomUtil.XLINK_NS,
"href",t);else if("text"==h){v=a.text;if(!this._textMeasureWidth||this._textMeasure!=v){var x=b.create("div","",document.body);x.style.position="absolute";x.style.visibility="hidden";x.style.width=x.style.height="auto";x.style.fontFamily=a.textFont;x.style.fontStyle="italic"==a.textStyle?"italic":"normal";x.style.fontWeight="bold"==a.textStyle?"bold":"normal";x.style.fontSize=m+"px";x.innerHTML=v;this._textMeasureWidth=x.clientWidth+4;x.parentNode.removeChild(x);this._textMeasure=v}s.setAttribute("x",
t);s.setAttribute("y",y);s.setAttribute("font-size",m+"px");s.setAttribute("text-anchor","center"==a.textAlign?"middle":"left"==a.textAlign?"start":"end");s.setAttribute("alignment-baseline","middle");s.setAttribute("font-family",a.textFont);s.setAttribute("font-style","italic"==a.textStyle?"italic":"normal");s.setAttribute("font-weight","bold"==a.textStyle?"bold":"normal");s.innerHTML=s.textContent=a.text}s.setAttribute("transform",w)}this._updateStyles()}},_updateStyles:function(){var b=G.DomUtil,
a=this.options,c=this._layer._defs,d;for(d in this._points){var e=this._points[d];(a.outline||this._mouseOver||this._editing)&&"text"!=a.shape?(e.setAttribute("stroke",this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor),e.setAttribute("stroke-dasharray",a.outlineDashArray.join(" ")),e.setAttribute("stroke-width",this._mouseOver?a.outlineWidth+a.lineHighlightWiden:a.outlineWidth),e.setAttribute("stroke-opacity",a.outlineOpacity)):e.setAttribute("stroke","none");if(a.fill)if(a.fillImage){var f=
G.Browser.getImageSrc(a.fillImage),h=a.fillImageSize,f=b.svgImagePattern(c,f,h[0],h[1]);e.setAttribute("fill","url(#"+f+")");e.setAttribute("fill-opacity",a.fillOpacity)}else a.gradual?(f=b.svgGradient(c,a.fillColor,a.fillOpacity),e.setAttribute("fill","url(#"+f+")")):(e.setAttribute("fill",a.fillColor),e.setAttribute("fill-opacity",a.fillOpacity));else e.setAttribute("fill","none")}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,
this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=this._layer;if(b){var b=b._map,a=G.DomUtil;this._updateStyles();this._isVertex?a.addClass(b._layersFrame,"g-edit"):a.addClass(b._layersFrame,"g-clickable")}},_onMouseOut:function(){var b=
this._layer;if(b){var b=b._map,a=G.DomUtil;this._updateStyles();this._isVertex?a.removeClass(b._layersFrame,"g-edit"):a.removeClass(b._layersFrame,"g-clickable")}}});
G.Graphic.Polyline=G.Graphic.Polyline.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._polylines={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this._layer,c=a._map;if(this.geom){a=a._svg;this._dom&&(a&&!this._dom.parentNode)&&a.appendChild(this._dom);for(var d=c.getSize(),e=c.getDrawSize(),a=(e[0]-d[0])/
2,d=(e[1]-d[1])/2,e=this.geom,f=e.length,h=this.bbox,h=c._calcWrapPointRange([(h[0]+h[2])/2,(h[1]+h[3])/2])||[0,0],k=c.options.maxExtent,k=k[2]-k[0],m=h[0];m<=h[1];m++){var q=this._polylines[m];q||(q=this._polylines[m]=b.createSVG("polyline"),q._graphic=this,this._dom.appendChild(q));for(var p="",l,n,r=0;r<f;r++)l=c.toScreen([e[r][0]+m*k,e[r][1]],0,0,!0),n=l[0]+a,l=l[1]+d,p+=p?" ":"",p+=n+","+l;q.setAttribute("points",p)}this._updateStyles()}},_updateStyles:function(){var b=this.options,a;for(a in this._polylines){var c=
this._polylines[a];c.setAttribute("stroke",this._editing?b.lineHighlightColor:b.lineColor);c.setAttribute("stroke-dasharray",b.lineDashArray.join(" "));c.setAttribute("stroke-linecap",b.lineCap);c.setAttribute("stroke-linejoin",b.lineJoin);c.setAttribute("stroke-opacity",b.lineOpacity);c.setAttribute("stroke-width",this._mouseOver?b.lineWidth+b.lineHighlightWiden:b.lineWidth);c.setAttribute("fill","none")}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],
this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();
G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Graphic.Polygon=G.Graphic.Polygon.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._polygons={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this._layer,c=a._map;if(this.geom){a=a._svg;this._dom&&(a&&!this._dom.parentNode)&&a.appendChild(this._dom);for(var d=c.getSize(),e=c.getDrawSize(),a=(e[0]-d[0])/2,d=
(e[1]-d[1])/2,e=this.geom,f=this.bbox,f=c._calcWrapPointRange([(f[0]+f[2])/2,(f[1]+f[3])/2])||[0,0],h=c.options.maxExtent,h=h[2]-h[0],k=f[0];k<=f[1];k++){var m=this._polygons[k];m||(m=this._polygons[k]=b.createSVG("path"),m._graphic=this,this._dom.appendChild(m));for(var q="",p,l,n,r,u=0,s=e.length;u<s;u++){p=e[u];l="";for(var t=0,w=p.length;t<w;t++)n=c.toScreen([p[t][0]+k*h,p[t][1]],0,0,!0),r=n[0]+a,n=n[1]+d,l+=0===t?" M ":"",l+=1===t?" L ":" ",l+=r+" "+n;l+=" Z";q+=l}m.setAttribute("d",q)}this._updateStyles()}},
_updateStyles:function(){var b=G.DomUtil,a=this.options,c=this._layer._defs,d;for(d in this._polygons){var e=this._polygons[d];a.outline||this._mouseOver||this._editing?(e.setAttribute("stroke",this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor),e.setAttribute("stroke-dasharray",a.outlineDashArray.join(" ")),e.setAttribute("stroke-linecap",a.outlineCap),e.setAttribute("stroke-linejoin",a.outlineJoin),e.setAttribute("stroke-width",(a.outline?a.outlineWidth:0)+(this._mouseOver?
a.lineHighlightWiden:0)),e.setAttribute("stroke-opacity",a.outlineOpacity)):e.setAttribute("stroke","none");if(a.fill){if(a.fillImage){var f=G.Browser.getImageSrc(a.fillImage),h=a.fillImageSize,f=b.svgImagePattern(c,f,h[0],h[1]);e.setAttribute("fill","url(#"+f+")")}else e.setAttribute("fill",a.fillColor);e.setAttribute("fill-opacity",a.fillOpacity)}else e.setAttribute("fill","none")}},_updateMask:function(){var b=G.DomUtil,a=this._map;if(this.geom){this._masks=this._masks||{};for(var c=a.getSize(),
d=a.getDrawSize(),e=(d[0]-c[0])/2,c=(d[1]-c[1])/2,d=this.geom,f=this.bbox,f=a._calcWrapPointRange([(f[0]+f[2])/2,(f[1]+f[3])/2])||[0,0],h=a.options.maxExtent,h=h[2]-h[0],k=f[0];k<=f[1];k++){var m=this._masks[k];m||(m=this._masks[k]=b.createSVG("path"),m._graphic=this);for(var q="",p,l,n,r,u=0,s=d.length;u<s;u++){p=d[u];l="";for(var t=0,w=p.length;t<w;t++)n=a.toScreen([p[t][0]+k*h,p[t][1]],0,0,!0),r=n[0]+e,n=n[1]+c,l+=0===t?" M ":"",l+=1===t?" L ":" ",l+=r+" "+n;l+=" Z";q+=l}m.setAttribute("d",q)}}},
_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=this._layer._map;this._updateStyles();
G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Graphic.MultiPoint=G.Graphic.MultiPoint.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._pointss={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this.options,c=this._layer,d=c._map,e=this.geom;if(e&&e.m){c=c._svg;this._dom&&(c&&!this._dom.parentNode)&&c.appendChild(this._dom);var f=d.getSize(),h=d.getDrawSize(),
c=(h[0]-f[0])/2,f=(h[1]-f[1])/2,h=d._rotate,k=a.shape,m=a.size,q=m[0],m=m[1],p=a.offset,l=a.imageRotate;"image"==k&&l&&(h-=l);"image"!=k||a.imageGravity||(h-=d._rotate);for(var e=e.m,n,r,u,l=this.bbox,l=d._calcWrapPointRange([(l[0]+l[2])/2,(l[1]+l[3])/2])||[0,0],s=d.options.maxExtent,s=s[2]-s[0],t=l[0];t<=l[1];t++)for(var w=this._pointss[t]=this._pointss[t]||[],v=0;v<e.length;v++){n=e[v];r=n[0];u=n[1];n=w[v];n||(n="rect"==k?this._pointss[t][v]=b.createSVG("rect"):"image"==k?this._pointss[t][v]=b.createSVG("image"):
"text"==k?this._pointss[t][v]=b.createSVG("text"):this._pointss[t][v]=b.createSVG("circle"),n._graphic=this,this._dom.appendChild(n));r=d.toScreen([r+t*s,u],0,0,!0);var y=r[0]+c,x=r[1]+f;r=y+p[0];u=x+p[1];y="rotate("+-h+","+y+","+x+")";if("circle"==k)n.setAttribute("cx",r),n.setAttribute("cy",u),n.setAttribute("r",q/2);else if("rect"==k)n.setAttribute("x",r-q/2),n.setAttribute("y",u-m/2),n.setAttribute("width",q),n.setAttribute("height",m);else if("image"==k)n.setAttribute("x",r),n.setAttribute("y",
u),n.setAttribute("width",q),n.setAttribute("height",m),r=G.Browser.getImageSrc(a.image),n.setAttributeNS(G.DomUtil.XLINK_NS,"href",r);else if("text"==k){x=a.text;if(!this._textMeasureWidth||this._textMeasure!=x){var z=b.create("div","",document.body);z.style.position="absolute";z.style.visibility="hidden";z.style.width=z.style.height="auto";z.style.fontFamily=a.textFont;z.style.fontStyle="italic"==a.textStyle?"italic":"normal";z.style.fontWeight="bold"==a.textStyle?"bold":"normal";z.style.fontSize=
q+"px";z.innerHTML=x;this._textMeasureWidth=z.clientWidth+4;z.parentNode.removeChild(z);this._textMeasure=x}n.setAttribute("x",r);n.setAttribute("y",u);n.setAttribute("font-size",q+"px");n.setAttribute("text-anchor","center"==a.textAlign?"middle":"left"==a.textAlign?"start":"end");n.setAttribute("alignment-baseline","middle");n.setAttribute("font-family",a.textFont);n.setAttribute("font-style","italic"==a.textStyle?"italic":"normal");n.setAttribute("font-weight","bold"==a.textStyle?"bold":"normal");
n.innerHTML=n.textContent=a.text}n.setAttribute("transform",y)}this._updateStyles()}},_updateStyles:function(){var b=G.DomUtil,a=this.options,c=this._layer._defs,d;for(d in this._pointss){var e=this._pointss[d],f;for(f in e){var h=e[f];(a.outline||this._mouseOver||this._editing)&&"text"!=a.shape?(h.setAttribute("stroke",this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor),h.setAttribute("stroke-dasharray",a.outlineDashArray.join(" ")),h.setAttribute("stroke-width",this._mouseOver?
a.outlineWidth+a.lineHighlightWiden:a.outlineWidth),h.setAttribute("stroke-opacity",a.outlineOpacity)):h.setAttribute("stroke","none");if(a.fill)if(a.fillImage){var k=G.Browser.getImageSrc(a.fillImage),m=a.fillImageSize,k=b.svgImagePattern(c,k,m[0],m[1]);h.setAttribute("fill","url(#"+k+")");h.setAttribute("fill-opacity",a.fillOpacity)}else a.gradual?(k=b.svgGradient(c,a.fillColor,a.fillOpacity),h.setAttribute("fill","url(#"+k+")")):(h.setAttribute("fill",a.fillColor),h.setAttribute("fill-opacity",
a.fillOpacity));else h.setAttribute("fill","none")}}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=
this._layer;if(b){var b=b._map,a=G.DomUtil;this._updateStyles();this._isVertex?a.addClass(b._layersFrame,"g-edit"):a.addClass(b._layersFrame,"g-clickable")}},_onMouseOut:function(){var b=this._layer;if(b){var b=b._map,a=G.DomUtil;this._updateStyles();this._isVertex?a.removeClass(b._layersFrame,"g-edit"):a.removeClass(b._layersFrame,"g-clickable")}}});
G.Graphic.MultiPolyline=G.Graphic.MultiPolyline.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._polyliness={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this._layer,c=a._map,d=this.geom;if(d&&d.m){a=a._svg;this._dom&&(a&&!this._dom.parentNode)&&a.appendChild(this._dom);for(var e=c.getSize(),f=c.getDrawSize(),
a=(f[0]-e[0])/2,e=(f[1]-e[1])/2,d=d.m,f=this.bbox,f=c._calcWrapPointRange([(f[0]+f[2])/2,(f[1]+f[3])/2])||[0,0],h=c.options.maxExtent,h=h[2]-h[0],k=f[0];k<=f[1];k++){this._polyliness[k]=this._polyliness[k]||[];for(var m=0;m<d.length;m++){var q=this._polyliness[k][m];q||(q=this._polyliness[k][m]=b.createSVG("polyline"),q._graphic=this,this._dom.appendChild(q));for(var p="",l,n,r=d[m],u=0,s=r.length;u<s;u++)l=c.toScreen([r[u][0]+k*h,r[u][1]],0,0,!0),n=l[0]+a,l=l[1]+e,p+=p?" ":"",p+=n+","+l;q.setAttribute("points",
p)}}this._updateStyles()}},_updateStyles:function(){var b=this.options,a;for(a in this._polyliness){var c=this._polyliness[a],d;for(d in c){var e=c[d];e.setAttribute("stroke",this._editing?b.lineHighlightColor:b.lineColor);e.setAttribute("stroke-dasharray",b.lineDashArray.join(" "));e.setAttribute("stroke-linecap",b.lineCap);e.setAttribute("stroke-linejoin",b.lineJoin);e.setAttribute("stroke-opacity",b.lineOpacity);e.setAttribute("stroke-width",this._mouseOver?b.lineWidth+b.lineHighlightWiden:b.lineWidth);
e.setAttribute("fill","none")}}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=this._layer._map;
this._updateStyles();G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Graphic.MultiPolygon=G.Graphic.MultiPolygon.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._polygonss={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this._layer,c=a._map,d=this.geom;if(d&&d.m){a=a._svg;this._dom&&(a&&!this._dom.parentNode)&&a.appendChild(this._dom);for(var e=c.getSize(),f=c.getDrawSize(),
a=(f[0]-e[0])/2,e=(f[1]-e[1])/2,d=d.m,f=this.bbox,f=c._calcWrapPointRange([(f[0]+f[2])/2,(f[1]+f[3])/2])||[0,0],h=c.options.maxExtent,h=h[2]-h[0],k=f[0];k<=f[1];k++){this._polygonss[k]=this._polygonss[k]||[];for(var m=0;m<d.length;m++){var q=this._polygonss[k][m];q||(q=this._polygonss[k][m]=b.createSVG("path"),q._graphic=this,this._dom.appendChild(q));for(var p="",l,n,r,u,s=d[m],t=0,w=s.length;t<w;t++){l=s[t];n="";for(var v=0,y=l.length;v<y;v++)r=c.toScreen([l[v][0]+k*h,l[v][1]],0,0,!0),u=r[0]+a,
r=r[1]+e,n+=0===v?" M ":"",n+=1===v?" L ":" ",n+=u+" "+r;n+=" Z";p+=n}q.setAttribute("d",p)}}this._updateStyles()}},_updateStyles:function(){var b=G.DomUtil,a=this.options,c=this._layer._defs,d;for(d in this._polygonss){var e=this._polygonss[d],f;for(f in e){var h=e[f];a.outline||this._mouseOver||this._editing?(h.setAttribute("stroke",this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor),h.setAttribute("stroke-dasharray",a.outlineDashArray.join(" ")),h.setAttribute("stroke-linecap",
a.outlineCap),h.setAttribute("stroke-linejoin",a.outlineJoin),h.setAttribute("stroke-width",(a.outline?a.outlineWidth:0)+(this._mouseOver?a.lineHighlightWiden:0)),h.setAttribute("stroke-opacity",a.outlineOpacity)):h.setAttribute("stroke","none");if(a.fill){if(a.fillImage){var k=G.Browser.getImageSrc(a.fillImage),m=a.fillImageSize,k=b.svgImagePattern(c,k,m[0],m[1]);h.setAttribute("fill","url(#"+k+")")}else h.setAttribute("fill",a.fillColor);h.setAttribute("fill-opacity",a.fillOpacity)}else h.setAttribute("fill",
"none")}}},_updateMask:function(){var b=G.DomUtil,a=this._map,c=this.geom;if(c&&c.m){this._maskss=this._maskss||{};for(var d=a.getSize(),e=a.getDrawSize(),f=(e[0]-d[0])/2,d=(e[1]-d[1])/2,c=c.m,e=this.bbox,e=a._calcWrapPointRange([(e[0]+e[2])/2,(e[1]+e[3])/2])||[0,0],h=a.options.maxExtent,h=h[2]-h[0],k=e[0];k<=e[1];k++){this._maskss[k]=this._maskss[k]||[];for(var m=0;m<c.length;m++){var q=this._masks[k][m];q||(q=this._masks[k][m]=b.createSVG("path"),q._graphic=this);for(var p="",l,n,r,u,s=c[m],t=0,
w=s.length;t<w;t++){l=s[t];n="";for(var v=0,y=l.length;v<y;v++)r=a.toScreen([l[v][0]+k*h,l[v][1]],0,0,!0),u=r[0]+f,r=r[1]+d,n+=0===v?" M ":"",n+=1===v?" L ":" ",n+=u+" "+r;n+=" Z";p+=n}q.setAttribute("d",p)}}}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,
this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Graphic.Circle=G.Graphic.Circle.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._circles={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this._layer,c=a._map;if(this.geom){a=a._svg;this._dom&&(a&&!this._dom.parentNode)&&a.appendChild(this._dom);for(var d=c.getSize(),e=c.getDrawSize(),a=(e[0]-d[0])/2,d=(e[1]-
d[1])/2,e=c._res,f=this.geom[0],h=this.geom[1],k=this.geom[2],m=c._calcWrapPointRange(this.geom)||[0,0],q=c.options.maxExtent,q=q[2]-q[0],p=m[0];p<=m[1];p++){var l=this._circles[p];l||(l=this._circles[p]=b.createSVG("circle"),l._graphic=this,this._dom.appendChild(l));var n=c.toScreen([f+p*q,h],0,0,!0),r=n[1]+d,u=k/e;l.setAttribute("cx",n[0]+a);l.setAttribute("cy",r);l.setAttribute("r",u)}this._updateStyles()}},_updateStyles:function(){var b=G.DomUtil,a=this.options,c=this._layer._defs,d;for(d in this._circles){var e=
this._circles[d];a.outline||this._mouseOver||this._editing?(e.setAttribute("stroke",this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor),e.setAttribute("stroke-dasharray",a.outlineDashArray.join(" ")),e.setAttribute("stroke-linecap",a.outlineCap),e.setAttribute("stroke-linejoin",a.outlineJoin),e.setAttribute("stroke-width",this._mouseOver?a.outlineWidth+a.lineHighlightWiden:a.outlineWidth),e.setAttribute("stroke-opacity",a.outlineOpacity)):this._mouseOver?(e.setAttribute("stroke",
a.outlineColor),e.setAttribute("stroke-width",this._mouseOver?a.lineHighlightWiden:0)):e.setAttribute("stroke","none");if(a.fill)if(a.fillImage){var f=G.Browser.getImageSrc(a.fillImage),h=a.fillImageSize,f=b.svgImagePattern(c,f,h[0],h[1]);e.setAttribute("fill","url(#"+f+")");e.setAttribute("fill-opacity",a.fillOpacity)}else a.gradual?(f=b.svgGradient(c,a.fillColor,a.fillOpacity),e.setAttribute("fill","url(#"+f+")")):(e.setAttribute("fill",a.fillColor),e.setAttribute("fill-opacity",a.fillOpacity));
else e.setAttribute("fill","none")}},_updateMask:function(){var b=G.DomUtil,a=this._map;if(this.geom){this._masks=this._masks||{};for(var c=a.getSize(),d=a.getDrawSize(),e=(d[0]-c[0])/2,c=(d[1]-c[1])/2,d=a._res,f=this.geom,h=f[0],k=f[1],f=f[2],m=a._calcWrapPointRange([h,k])||[0,0],q=a.options.maxExtent,q=q[2]-q[0],p=m[0];p<=m[1];p++){var l=this._masks[p];l||(l=this._masks[p]=b.createSVG("circle"),l._graphic=this);var n=a.toScreen([h+p*q,k],0,0,!0),r=n[1]+c,u=f/d;l.setAttribute("cx",n[0]+e);l.setAttribute("cy",
r);l.setAttribute("r",u)}}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=this._layer._map;
this._updateStyles();G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Graphic.Arrow=G.Graphic.Arrow.extend({_onAdded:function(){this._dom||(this._dom=G.DomUtil.createSVG("g"));this._polygons={};var b=this._layer._map;b&&b._requestRedraw()},_onRemoved:function(){var b=this._dom;b&&b.parentNode&&b.parentNode.removeChild(b);(b=this._layer._map)&&b._requestRedraw()},_draw:function(){var b=G.DomUtil,a=this._layer,c=a._map;this._updateGeomDraw(c._res);if(this._geomDraw){a=a._svg;this._dom&&(a&&!this._dom.parentNode)&&a.appendChild(this._dom);for(var d=c.getSize(),e=c.getDrawSize(),
a=(e[0]-d[0])/2,d=(e[1]-d[1])/2,e=this._geomDraw,f=this.bbox,f=c._calcWrapPointRange([(f[0]+f[2])/2,(f[1]+f[3])/2])||[0,0],h=c.options.maxExtent,h=h[2]-h[0],k=f[0];k<=f[1];k++){var m=this._polygons[k];m||(m=this._polygons[k]=b.createSVG("path"),m._graphic=this,this._dom.appendChild(m));for(var q="",p,l,n,r,u=0,s=e.length;u<s;u++){p=e[u];l="";for(var t=0,w=p.length;t<w;t++)n=c.toScreen([p[t][0]+k*h,p[t][1]],0,0,!0),r=n[0]+a,n=n[1]+d,l+=0===t?" M ":"",l+=1===t?" L ":" ",l+=r+" "+n;l+=" Z";q+=l}m.setAttribute("d",
q)}this._updateStyles()}},_updateStyles:function(){var b=G.DomUtil,a=this.options,c=this._layer._defs,d;for(d in this._polygons){var e=this._polygons[d];a.outline||this._mouseOver||this._editing?(e.setAttribute("stroke",this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor),e.setAttribute("stroke-dasharray",a.outlineDashArray.join(" ")),e.setAttribute("stroke-linecap",a.outlineCap),e.setAttribute("stroke-linejoin",a.outlineJoin),e.setAttribute("stroke-width",(a.outline?a.outlineWidth:
0)+(this._mouseOver?a.lineHighlightWiden:0)),e.setAttribute("stroke-opacity",a.outlineOpacity)):e.setAttribute("stroke","none");if(a.fill){if(a.fillImage){var f=G.Browser.getImageSrc(a.fillImage),h=a.fillImageSize,f=b.svgImagePattern(c,f,h[0],h[1]);e.setAttribute("fill","url(#"+f+")")}else e.setAttribute("fill",a.fillColor);e.setAttribute("fill-opacity",a.fillOpacity)}else e.setAttribute("fill","none")}},_updateMask:function(){var b=G.DomUtil,a=this._map;this._updateGeomDraw(a._res);if(this._geomDraw){this._masks=
this._masks||{};for(var c=a.getSize(),d=a.getDrawSize(),e=(d[0]-c[0])/2,c=(d[1]-c[1])/2,d=this._geomDraw,f=this.bbox,f=a._calcWrapPointRange([(f[0]+f[2])/2,(f[1]+f[3])/2])||[0,0],h=a.options.maxExtent,h=h[2]-h[0],k=f[0];k<=f[1];k++){var m=this._masks[k];m||(m=this._masks[k]=b.createSVG("path"),m._graphic=this);for(var q="",p,l,n,r,u=0,s=d.length;u<s;u++){p=d[u];l="";for(var t=0,w=p.length;t<w;t++)n=a.toScreen([p[t][0]+k*h,p[t][1]],0,0,!0),r=n[0]+e,n=n[1]+c,l+=0===t?" M ":"",l+=1===t?" L ":" ",l+=
r+" "+n;l+=" Z";q+=l}m.setAttribute("d",q)}}},_onStartEdit:function(){var b=this._layer._map,a=this.virtualMouse;for(i in a.DOWN)b.addListener(a.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var b=this._layer._map,a=this.virtualMouse,c,d;for(c in a.DOWN)d=a.DOWN[c],b.removeListener(d,this._onVertexDragStart,this),b.removeListener(a.MOVE[d],this._onVertexDrag,this),b.removeListener(a.UP[d],this._onVertexDragEnd,this);this._removeVertexes()},_onMouseOver:function(){var b=
this._layer._map;this._updateStyles();G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Graphic.Group=G.Graphic.Group.extend({_updateStyles:function(){var b=this._graphics,a,c,d;if(b&&b.length)for(a=0,c=b.length;a<c;a++)d=b[a],d._updateStyles&&d._updateStyles()},_onMouseOver:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.addClass(b._layersFrame,"g-clickable")},_onMouseOut:function(){var b=this._layer._map;this._updateStyles();G.DomUtil.removeClass(b._layersFrame,"g-clickable")}});
G.Map=G.Map.extend({_initAddition:function(){var b=G.DomUtil,a=this._maskFrame,c=a._svg=b.createSVG("svg","g-graphic-container g-zoom-animated",a),c=a._defs=b.createSVG("defs","",c),a=a._mask=b.createSVG("mask","",c);a.setAttribute("id","svg_mask");b=a._base=b.createSVG("rect","",a);b.setAttribute("width","100%");b.setAttribute("height","100%");b.setAttribute("fill","#fff");this._mode="svg"},_drawMask:function(){var b=this.options,a=G.DomUtil,c=this._maskFrame,d=c._svg,e=c._mask;if(b.mask&&this._masks&&
0<this._masks.length){a.show(d);var c=a.getPosition(this._mapFrame),f=this.getSize(),h=this.getDrawSize(),k=h[0],h=h[1];d.style[a.Transform]=a.genTranslateStyle(-((k-f[0])/2),-((h-f[1])/2));d.setAttribute("width",k);d.setAttribute("height",h);d.setAttribute("viewBox",[-c[0],-c[1],k,h].join(" "));var f=this.getCenter(),m=this._res;G.ExtentUtil.intersect([f[0]-k*m/2,f[1]-h*m/2,f[0]+k*m/2,f[1]+h*m/2],this.options.maxExtent);for(var q in this._masks){f=this._masks[q];f._updateMask();for(var p in f._masks)(m=
f._masks[p])&&(m.parentNode||e.appendChild(m))}a=d._rect=d._rect?d._rect:a.createSVG("rect");a.setAttribute("x",-c[0]);a.setAttribute("y",-c[1]);a.setAttribute("width",k);a.setAttribute("height",h);a.setAttribute("mask","url(#svg_mask)");a.setAttribute("fill",b.maskColor);a.setAttribute("fill-opacity",b.maskOpacity);a.parentNode||d.appendChild(a)}else a.hide(d)},_onZoomStart:function(b){var a=this._mapFrame,c=this._maskFrame._svg,d=this._rotate,e=G.DomUtil,f=e.Transition,e=e.Transform;self._zooming||
(self._zooming=!0);var h=this.getSize(),k=this.getDrawSize(),m=(k[0]-h[0])/2,k=(k[1]-h[1])/2,h=[h[0]/2,h[1]/2],q=b.aroundScreen||h,p=h[0]-q[0],l=h[1]-q[1];d&&(p&&l)&&(d=G.MathUtil.rotateVector([p,l],-d),q=[h[0]-d[0],h[1]-d[1]]);q=self._aroundScreen=[q[0]-h[0],q[1]-h[1]];b=G.DomUtil.genScaleStyle(1/b.scale,q[0],q[1],-m,-k);c.style[e]=b;this._zoomAnim&&this._zoomAnim._params.ignoreAnim||(c.style[f]=a.style[f])},_onZoomUpdate:function(b){var a=this._mapFrame,c=this._maskFrame._svg,d=G.DomUtil,e=d.Transition,
d=d.Transform;if(self._zooming){var f=self._aroundScreen,h=this.getSize(),k=this.getDrawSize();b=G.DomUtil.genScaleStyle(1/b.scale,f[0],f[1],-((k[0]-h[0])/2),-((k[1]-h[1])/2));c.style[d]=b;this._zoomAnim&&this._zoomAnim._params.ignoreAnim||(c.style[e]=a.style[e])}},_onZoomEnd:function(){var b=this._maskFrame._svg,a=G.DomUtil,c=this.getSize(),d=this.getDrawSize(),e=(d[0]-c[0])/2,c=(d[1]-c[1])/2;b.style.visibility="";b.parentNode.appendChild(b);b.style[a.Transform]=a.genTranslateStyle(-e,-c);b.style[a.Transition]=
"";self._zooming=!1}});
