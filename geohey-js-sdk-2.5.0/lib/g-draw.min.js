G.Layer.Draw=G.Layer.Graphic.extend({forbidKeys:["DoubleClick","Pinch","Drag","ShiftDrag"],startDraw:function(a,c){var b=this._map;this._handler&&this._handler.off();this._drawOptions=G.Util.merge(c||{},{clickable:!1});"circle"==a?this._handler=(new G.DrawHandler.Circle(this)).on():"point"==a?this._handler=(new G.DrawHandler.Point(this)).on():"polyline"==a?this._handler=(new G.DrawHandler.Polyline(this)).on():"freepolyline"==a?this._handler=(new G.DrawHandler.Freepolyline(this)).on():"polygon"==a?
this._handler=(new G.DrawHandler.Polygon(this)).on():"freepolygon"==a?this._handler=(new G.DrawHandler.Freepolygon(this)).on():"rect"==a?this._handler=(new G.DrawHandler.Rect(this)).on():"normalrect"==a?this._handler=(new G.DrawHandler.NormalRect(this)).on():"arrow"==a&&(this._handler=(new G.DrawHandler.Arrow(this)).on());if(this._drawing)return this;G.DomUtil.addClass(b._layersFrame,"g-edit");this._drawing=!0;var d,e,f=this.forbidKeys;for(d in f)if(e=f[d],e=b._handlers[e])e._forbidden=!0,e.off();
return this},endDraw:function(){var a=this._map,c,b,d;if(this._drawing){(d=this._handler)&&d.off();delete d._graphic;this._drawing=!1;b=this.forbidKeys;for(c in b)if(d=b[c],d=a._handlers[d])d._forbidden=!1;a._resetHandlers();G.DomUtil.removeClass(a._layersFrame,"g-edit")}return this}});
G.DrawHandler=G.Class.extend({mixins:[G.Event],init:function(a){this._layer=a;this._enabled=!1;return this},on:function(){this._enabled||(this._enabled=!0,delete this._graphic,this.afterOn());return this},off:function(){if(this._enabled){this._enabled=!1;var a=this._graphic,c=this._layer;a&&(c&&c._drawing&&(a instanceof G.Graphic.Polyline||a instanceof G.Graphic.Polygon))&&c.fireEvent("drawEnd",{graphic:a});this.afterOff()}return this},afterOn:function(){},afterOff:function(){}});
G.DrawHandler.Circle=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.addListener(c.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.removeListener(c.DOWN[b],this._onDown,this),a.removeListener(c.MOVE[b],this._onMove),a.removeListener(c.UP[b],this._onUp)},_onDown:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);d.disableImageDrag();d.disableTextSelection();
d=this.virtualMouse;b.addListener(d.MOVE[a.type],this._onMove,this);b.addListener(d.UP[a.type],this._onUp,this);var e=[a.mapX,a.mapY],d=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),d=[e[0]-a.mapX,e[1]-a.mapY]);a=this._graphic=(new G.Graphic.Circle([e[0],e[1],0],null,c._drawOptions)).addTo(c);a._wrapOffset=d;c.fireEvent("drawStart",{graphic:a})},_onMove:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);var d=this._graphic,e=d.geom;a=[a.mapX,a.mapY];if(b.options.wrap){var f=
d._wrapOffset;a[0]+=f[0];a[1]+=f[1]}a=G.MathUtil.calcHypotenuse(a[0]-e[0],a[1]-e[1]);e[2]=a;d.updateGeom();b._requestRedraw();c.fireEvent("draw",{graphic:d})},_onUp:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);a=this.virtualMouse;for(var e in a.MOVE)b.removeListener(a.MOVE[e],this._onMove),b.removeListener(a.UP[e],this._onUp);c.fireEvent("drawEnd",{graphic:this._graphic})}});
G.DrawHandler.Point=G.DrawHandler.extend({afterOn:function(){this._layer._map.addListener("click",this._onClick,this)},afterOff:function(){this._layer._map.removeListener("click",this._onClick,this)},_onClick:function(a){var c=this._layer,b=c._map;a.cancel();a=[a.mapX,a.mapY];b.options.wrap&&(a=b._calcRealCoords(a));a=this._graphic=(new G.Graphic.Point(a,null,c._drawOptions)).addTo(c);c.fireEvent("drawStart",{graphic:a}).fireEvent("draw",{graphic:a}).fireEvent("drawEnd",{graphic:a});b._requestRedraw()}});
G.DrawHandler.Polyline=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.MOVE)a.removeListener(c.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.removeListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();
var e=this._graphic,f=[a.mapX,a.mapY],h;if(e)this._ptIndex++,b.options.wrap&&(g=e._wrapOffset,f[0]+=g[0],f[1]+=g[1]),a=e.geom,a[this._ptIndex]=f,e.updateGeom(),b._requestRedraw(),c.fireEvent("draw",{graphic:e});else{var g=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),g=[f[0]-a.mapX,f[1]-a.mapY]);a=[f,f];e=this._graphic=(new G.Graphic.Polyline(a,null,c._drawOptions)).addTo(c);e._wrapOffset=g;this._ptIndex=0;for(h in d.MOVE)b.addListener(d.MOVE[h],this._onMove,this);this._realDoubleZoom=b.options.doubleZoom;
b.options.doubleZoom=!1;b._requestRedraw();c.fireEvent("drawStart",{graphic:e})}},_onMove:function(a){var c=this._layer._map;a.cancel();var b=this._graphic;a=[a.mapX,a.mapY];var d;b&&(c.options.wrap&&(d=b._wrapOffset,a[0]+=d[0],a[1]+=d[1]),d=b.geom,d[this._ptIndex+1]=a,b.updateGeom(),c._requestRedraw())},_onDoubleClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();for(var e in d.MOVE)b.removeListener(d.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;b.options.doubleZoom=
this._realDoubleZoom||b.options.doubleZoom;a&&(a.geom&&2<a.geom.length&&(a.geom.splice(a.geom.length-1),a.updateGeom()),b._requestRedraw(),c.fireEvent("drawEnd",{graphic:a}))}});
G.DrawHandler.Freepolyline=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.addListener(c.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.removeListener(c.DOWN[b],this._onDown,this),a.removeListener(c.MOVE[b],this._onMove),a.removeListener(c.UP[b],this._onUp)},_onDown:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);d.disableImageDrag();d.disableTextSelection();
d=this.virtualMouse;b.addListener(d.MOVE[a.type],this._onMove,this);b.addListener(d.UP[a.type],this._onUp,this);var e=this._graphic,f=[a.mapX,a.mapY];if(!e){var h=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),h=[f[0]-a.mapX,f[1]-a.mapY]);a=[f];e=this._graphic=(new G.Graphic.Polyline(a,null,c._drawOptions)).addTo(c);e._wrapOffset=h}for(var g in d.MOVE)b.addListener(d.MOVE[g],this._onMove,this);c.fireEvent("drawStart",{graphic:e})},_onMove:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);
d.preventDefault(a);var d=this._graphic,e=d.geom,f=e.length;e[f]=[a.mapX,a.mapY];b.options.wrap&&(a=d._wrapOffset,e[f][0]+=a[0],e[f][1]+=a[1]);d.updateGeom();b._requestRedraw();c.fireEvent("draw",{graphic:d})},_onUp:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);var d=this._graphic,e=d.geom,f=e.length;e[f]=[a.mapX,a.mapY];b.options.wrap&&(a=d._wrapOffset,e[f][0]+=a[0],e[f][1]+=a[1]);d.updateGeom();b._requestRedraw();a=this.virtualMouse;for(var h in a.MOVE)b.removeListener(a.MOVE[h],
this._onMove),b.removeListener(a.UP[h],this._onUp);delete this._graphic;c.fireEvent("drawEnd",{graphic:d})}});
G.DrawHandler.Polygon=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.MOVE)a.removeListener(c.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();
var e=this._graphic,f=[a.mapX,a.mapY],h;if(e)this._ptIndex++,b.options.wrap&&(g=e._wrapOffset,f[0]+=g[0],f[1]+=g[1]),a=e.geom,a[0][this._ptIndex]=f,e.updateGeom(),b._requestRedraw(),c.fireEvent("draw",{graphic:e});else{var g=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),g=[f[0]-a.mapX,f[1]-a.mapY]);a=[[f,f]];e=this._graphic=(new G.Graphic.Polygon(a,null,c._drawOptions)).addTo(c);e._wrapOffset=g;this._ptIndex=0;for(h in d.MOVE)b.addListener(d.MOVE[h],this._onMove,this);this._realDoubleZoom=b.options.doubleZoom;
b.options.doubleZoom=!1;b._requestRedraw();c.fireEvent("drawStart",{graphic:e})}},_onMove:function(a){var c=this._layer._map;a.cancel();var b=this._graphic;a=[a.mapX,a.mapY];var d;b&&(c.options.wrap&&(d=b._wrapOffset,a[0]+=d[0],a[1]+=d[1]),d=b.geom,d[0][this._ptIndex+1]=a,b.updateGeom(),c._requestRedraw())},_onDoubleClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();for(var e in d.MOVE)b.removeListener(d.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;b.options.doubleZoom=
this._realDoubleZoom||b.options.doubleZoom;a&&(a.geom&&(a.geom[0]&&3<a.geom[0].length)&&(a.geom[0].splice(a.geom[0].length-1),a.updateGeom()),b._requestRedraw(),c.fireEvent("drawEnd",{graphic:a}))}});
G.DrawHandler.Freepolygon=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.addListener(c.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.removeListener(c.DOWN[b],this._onDown,this),a.removeListener(c.MOVE[b],this._onMove),a.removeListener(c.UP[b],this._onUp)},_onDown:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);d.disableImageDrag();d.disableTextSelection();
d=this.virtualMouse;b.addListener(d.MOVE[a.type],this._onMove,this);b.addListener(d.UP[a.type],this._onUp,this);var e=this._graphic,f=[a.mapX,a.mapY];if(!e){var h=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),h=[f[0]-a.mapX,f[1]-a.mapY]);a=[[f]];e=this._graphic=(new G.Graphic.Polygon(a,null,c._drawOptions)).addTo(c);e._wrapOffset=h}for(var g in d.MOVE)b.addListener(d.MOVE[g],this._onMove,this);c.fireEvent("drawStart",{graphic:e})},_onMove:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);
d.preventDefault(a);var d=this._graphic,e=d.geom[0],f=e.length;e[f]=[a.mapX,a.mapY];b.options.wrap&&(a=d._wrapOffset,e[f][0]+=a[0],e[f][1]+=a[1]);d.updateGeom();b._requestRedraw();c.fireEvent("draw",{graphic:d})},_onUp:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);var d=this._graphic,e=d.geom[0],f=e.length;e[f]=[a.mapX,a.mapY];b.options.wrap&&(a=d._wrapOffset,e[f][0]+=a[0],e[f][1]+=a[1]);d.updateGeom();b._requestRedraw();a=this.virtualMouse;for(var h in a.MOVE)b.removeListener(a.MOVE[h],
this._onMove),b.removeListener(a.UP[h],this._onUp);delete this._graphic;c.fireEvent("drawEnd",{graphic:d})}});
G.DrawHandler.Rect=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.MOVE)a.removeListener(c.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();var e=
this._graphic,f=[a.mapX,a.mapY],h;if(e)b.options.wrap&&(g=e._wrapOffset,f[0]+=g[0],f[1]+=g[1]),this._p2?a=this._genRect(this._p1,this._p2,f):(this._p2=f,a=[[this._p1,f,f]]),e.updateGeom(a),b._requestRedraw(),c.fireEvent("draw",{graphic:e});else{var g=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),g=[f[0]-a.mapX,f[1]-a.mapY]);this._p1=f;a=[[f,f,f]];e=this._graphic=(new G.Graphic.Polygon(a,null,c._drawOptions)).addTo(c);e._wrapOffset=g;for(h in d.MOVE)b.addListener(d.MOVE[h],this._onMove,this);this._realDoubleZoom=
b.options.doubleZoom;b.options.doubleZoom=!1;b._requestRedraw();c.fireEvent("drawStart",{graphic:e})}},_onMove:function(a){var c=this._layer._map;a.cancel();var b=this._graphic;a=[a.mapX,a.mapY];var d=this._p1,e=this._p2;if(b&&d){if(c.options.wrap){var f=b._wrapOffset;a[0]+=f[0];a[1]+=f[1]}a=e?this._genRect(d,e,a):[[d,a,a]];b.updateGeom(a);c._requestRedraw()}},_onDoubleClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();for(var e in d.MOVE)b.removeListener(d.MOVE[e],this._onMove,
this);a=this._graphic;delete this._graphic;delete this._p1;delete this._p2;b.options.doubleZoom=this._realDoubleZoom||b.options.doubleZoom;a&&c.fireEvent("drawEnd",{graphic:a})},_genRect:function(a,c,b){var d=G.MathUtil.calcDistance(a,c);if(0==d)return[[a,c,b]];var e=((b[0]-a[0])*(c[0]-a[0])+(b[1]-a[1])*(c[1]-a[1]))/d/d,d=b[0]-(a[0]+e*(c[0]-a[0])),e=b[1]-(a[1]+e*(c[1]-a[1]));return 0==d*e?[[a,c,b]]:[[a,c,[c[0]+d,c[1]+e],[a[0]+d,a[1]+e]]]}});
G.DrawHandler.NormalRect=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.addListener(c.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.DOWN)a.removeListener(c.DOWN[b],this._onDown,this),a.removeListener(c.MOVE[b],this._onMove),a.removeListener(c.UP[b],this._onUp)},_onDown:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);d.disableImageDrag();d.disableTextSelection();
d=this.virtualMouse;b.addListener(d.MOVE[a.type],this._onMove,this);b.addListener(d.UP[a.type],this._onUp,this);var e=this._graphic,f=[a.mapX,a.mapY];if(!e){var h=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),h=[f[0]-a.mapX,f[1]-a.mapY]);a=[[f]];e=this._graphic=(new G.Graphic.Polygon(a,null,c._drawOptions)).addTo(c);e._wrapOffset=h}for(var g in d.MOVE)b.addListener(d.MOVE[g],this._onMove,this);c.fireEvent("drawStart",{graphic:e})},_onMove:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);
d.preventDefault(a);d=this._graphic;a=[a.mapX,a.mapY];if(b.options.wrap){var e=d._wrapOffset;a[0]+=e[0];a[1]+=e[1]}a=this._genRect(d.geom[0][0],a);d.updateGeom(a);b._requestRedraw();c.fireEvent("draw",{graphic:d})},_onUp:function(a){var c=this._layer,b=c._map,d=G.DomUtil;d.stopPropagation(a);d.preventDefault(a);a=this._graphic;a.updateGeom();b._requestRedraw();var d=this.virtualMouse,e;for(e in d.MOVE)b.removeListener(d.MOVE[e],this._onMove),b.removeListener(d.UP[e],this._onUp);delete this._graphic;
c.fireEvent("drawEnd",{graphic:a})},_genRect:function(a,c){return[[a,[a[0]+(c[0]-a[0]),a[1]],c,[a[0],a[1]+(c[1]-a[1])]]]}});
G.DrawHandler.Arrow=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,c=this.virtualMouse,b;for(b in c.MOVE)a.removeListener(c.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.removeListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();
var e=this._graphic,f=[a.mapX,a.mapY],h;if(e)this._ptIndex++,b.options.wrap&&(g=e._wrapOffset,f[0]+=g[0],f[1]+=g[1]),a=e.geom,a[this._ptIndex]=f,e.updateGeom(),b._requestRedraw(),c.fireEvent("draw",{graphic:e});else{var g=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),g=[f[0]-a.mapX,f[1]-a.mapY]);a=[f,f];e=this._graphic=(new G.Graphic.Arrow(a,null,c._drawOptions)).addTo(c);e._wrapOffset=g;this._ptIndex=0;for(h in d.MOVE)b.addListener(d.MOVE[h],this._onMove,this);this._realDoubleZoom=b.options.doubleZoom;
b.options.doubleZoom=!1;b._requestRedraw();c.fireEvent("drawStart",{graphic:e})}},_onMove:function(a){var c=this._layer._map;a.cancel();var b=this._graphic;a=[a.mapX,a.mapY];var d;b&&(c.options.wrap&&(d=b._wrapOffset,a[0]+=d[0],a[1]+=d[1]),d=b.geom,d[this._ptIndex+1]=a,b.updateGeom(),c._requestRedraw())},_onDoubleClick:function(a){var c=this._layer,b=c._map,d=this.virtualMouse;a.cancel();for(var e in d.MOVE)b.removeListener(d.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;b.options.doubleZoom=
this._realDoubleZoom||b.options.doubleZoom;a&&(a.geom&&2<a.geom.length&&(a.geom.splice(a.geom.length-1),a.updateGeom()),b._requestRedraw(),c.fireEvent("drawEnd",{graphic:a}))}});
