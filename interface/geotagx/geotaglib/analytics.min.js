/*! CCL-Tracker v0.1 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(a){window.analytics=a()}:window.define)(function(){var d="_ccl_tracking_accumulators",e="_ccl_tracking_delta",c="_ccl_tracking_incremental",f="_ccl_tracking_id";function a(){function j(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}var l="";for(var k=0;k<8;k++){l+=j()}return l}var h=function(){this.stack=[];this.enabled=false;this.expired=false;this.initializedAt=Date.now();this.timeoutTime=this.initializedAt+10000;this.listener=null;this.debug=false;this.disableChanged=false;this.trackingID=null;this.timers={};this.timerAccumulators={};this.globals={};this.probeTimer=setInterval(this.probeListener.bind(this),100);this.trackingID=this.getPermanent(f);if(!this.trackingID){this.trackingID=a();this.setPermanent(f,this.trackingID,365)}this.globals.trackid=this.trackingID};var i=window.localStorage,b=h.prototype;b.setPermanent=function(j,l,k){if(i){i.setItem(j,l)}else{this.createCookie(j,l,k)}if(this.disableChanged){return}if(window["$"]){$(this).triggerHandler("changed",[this.exportStore()])}};b.getPermanent=function(j){if(i){return i.getItem(j)}else{return this.getCookie(j)}};b.deletePermanent=function(j){if(i){return i.removeItem(j)}else{this.createCookie(j,"",-32)}if(this.disableChanged){return}if(window["$"]){$(this).triggerHandler("changed",[this.pack()])}};b.hasPermanent=function(j){if(i){return i.hasOwnProperty(j)}else{return(this.getCookie(j)!="")}};b.createCookie=function(l,m,n){var j;if(n){var k=new Date();k.setTime(k.getTime()+(n*24*60*60*1000));j="; expires="+k.toGMTString()}else{j=""}document.cookie=l+"="+m+j+"; path=/"};b.getCookie=function(k){var l,j;if(document.cookie.length>0){l=document.cookie.indexOf(k+"=");if(l!=-1){l=l+k.length+1;j=document.cookie.indexOf(";",l);if(j==-1){j=document.cookie.length}return unescape(document.cookie.substring(l,j))}}return""};b.probeListener=function(){if(this.enabled||this.expired){return}if(Date.now()>this.timeoutTime){clearInterval(this.probeTimer);this.expired=true;this.stack=[];console.warn("Analytics: No back-end registered on time");return}if(!window.analyticsListener){return}clearInterval(this.probeTimer);this.listener=window.analyticsListener;this.enabled=true;if(this.debug){console.log("Analytics: Registered back-end")}for(var j=0;j<this.stack.length;j++){this.send(this.stack[j][0],this.stack[j][1])}this.stack=[]};b.send=function(j,k){if(k.ts==undefined){k.ts=Date.now()}if(this.debug){console.log("Analytics: Sending",j,k)}if(this.listener){try{if(this.listener===true){$(window).trigger("analytics."+j,[k])}else{this.listener(j,k)}}catch(l){}}};b.fireEvent=function(l,o,n){this.probeListener();if(this.expired){return}if(!o){o={}}for(var j in this.globals){o[j]=this.globals[j]}if(this.enabled){this.send(l,o)}else{if(n){for(var m=0;m<this.stack.length;m++){if(this.stack[m][0]==l){this.stack[m]=[l,o];return}}}this.stack.push([l,o]);if(this.debug){console.log("Analytics: Scheduling",l,o)}}};b.setGlobal=function(j,k){this.globals[j]=k};b.freeze=function(){for(name in this.timers){this.timerAccumulators[name]+=(Date.now()-this.timers[name])}};b.thaw=function(){for(name in this.timers){this.timers[name]=Date.now()}};b.disable=function(){this.expired=true;this.enabled=false};b.startTimer=function(j){if(this.timers[j]!==undefined){return}this.timers[j]=Date.now();this.timerAccumulators[j]=0};b.restartTimer=function(j){var k=this.stopTimer(j);this.timers[j]=Date.now();this.timerAccumulators[j]=0;return k};b.getTimer=function(j){if(!this.timers[j]){return 0}return(Date.now()-this.timers[j])+this.timerAccumulators[j]};b.stopTimer=function(j){if(!this.timers[j]){return 0}var k=(Date.now()-this.timers[j])+this.timerAccumulators[j];delete this.timers[j];delete this.timerAccumulators[j];return k};b.fireIncrementalEvent=function(m,l,j,q){var n={name:m,property:null,interval:1,value:1};var l=l||{};if(typeof(j)=="string"){n.property=j}else{n.property=j.property;n.name=j.name||m;n.interval=j.interval||1;n.value=j.value||1}if(q!==undefined){n.value=q}var o={};if(this.hasPermanent(c)){o=JSON.parse(this.getPermanent(c))}if(!o[n.name]){o[n.name]=0}var p=o[n.name];var k=Math.floor(n.value/n.interval)*n.interval;if(k>p){for(var r=p+n.interval;r<=k;r+=n.interval){l[n.property]=r;this.fireEvent(m,l)}o[n.name]=k;this.setPermanent(c,JSON.stringify(o))}};b.clearAccum=function(k){var j={};if(this.hasPermanent(d)){j=JSON.parse(this.getPermanent(d))}if(accummulators[k]!==undefined){delete accummulators[k]}this.setPermanent(d,JSON.stringify(j))};b.clearAll=function(){i.deletePermanent(d);i.deletePermanent(e);i.deletePermanent(c)};b.accumulate=function(k,l){var j={};if(this.hasPermanent(d)){j=JSON.parse(this.getPermanent(d))}if(!j[k]){j[k]=l}else{j[k]+=l}this.setPermanent(d,JSON.stringify(j));return j[k]};b.clearDelta=function(k){var j={};if(this.hasPermanent(e)){j=JSON.parse(this.getPermanent(e))}if(accummulators[k]!==undefined){delete accummulators[k]}this.setPermanent(e,JSON.stringify(j))};b.delta=function(j,l){var k={};if(this.hasPermanent(e)){k=JSON.parse(this.getPermanent(e))}if(!k[j]){k[j]=0}var m=l-k[j];k[j]=l;this.setPermanent(e,JSON.stringify(k));return m};b.exportStore=function(){return btoa(JSON.stringify({a:this.getPermanent(d),d:this.getPermanent(e),i:this.getPermanent(c),t:this.getPermanent(f)}))};b.importStore=function(j){var j=JSON.parse(atob(j));this.disableChanged=true;if(j.a){this.setPermanent(d,j.a)}if(j.d){this.setPermanent(e,j.d)}if(j.i){this.setPermanent(c,j.i)}if(j.t){this.setPermanent(f,j.t)}this.disableChanged=false};var g=new h();window.addEventListener("blur",function(j){g.freeze()});window.addEventListener("focus",function(j){g.thaw()});return g});